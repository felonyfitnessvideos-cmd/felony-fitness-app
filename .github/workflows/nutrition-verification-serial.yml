name: Nutrition Verification - Serial Worker

# Single-threaded, gentle worker that prevents database stampedes
# Processes foods one batch at a time with concurrency control

on:
  schedule:
    # Run every 5 minutes - gentle background processing
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Batch size (default 3, max 5 to avoid timeout)'
        required: false
        default: '3'

# CRITICAL: Concurrency control ensures only ONE run at a time
# No parallel execution, no database stampede
concurrency:
  group: nutrition-verification-group
  cancel-in-progress: false  # Queue up runs instead of canceling

jobs:
  verify-nutrition-serial:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Verify Nutrition Data (Serial)
        id: verify
        run: |
          echo "üîç Starting gentle nutrition verification..."
          echo "‚öôÔ∏è  Mode: Single-threaded (no parallel workers)"
          
          # Batch size of 3 to prevent edge function timeout (150s limit)
          # Each food takes ~20-30s with OpenAI, so 3 foods = ~90s (safe margin)
          BATCH_SIZE="3"
          
          response=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -d "{\"batch_size\": ${BATCH_SIZE}}" \
            "${{ secrets.SUPABASE_URL }}/functions/v1/nutrition-verification")
          
          echo "Response: $response"
          
          if [ -z "$response" ]; then
            echo "‚úÖ Empty response - no foods to verify"
            exit 0
          fi
          
          if echo "$response" | jq . > /dev/null 2>&1; then
            verified=$(echo "$response" | jq -r '.verified // 0')
            portions=$(echo "$response" | jq -r '.portions_found // 0')
            errors=$(echo "$response" | jq -r '.errors // 0')
            remaining=$(echo "$response" | jq -r '.remaining // 0')
            
            echo "‚úÖ Verified: $verified foods"
            echo "üîç Portions discovered: $portions"
            echo "‚ùå Errors: $errors"
            echo "üìä Remaining: $remaining foods"
            
            # Log success
            if [ "$verified" -gt 0 ]; then
              echo "üéâ Successfully normalized $verified foods to 100g baseline"
            fi
            
            if [ "$portions" -gt 0 ]; then
              echo "üéâ Discovered $portions new serving portions"
            fi
            
            if [ "$remaining" -eq 0 ]; then
              echo "üèÜ DATABASE FULLY VERIFIED! All foods normalized to 100g."
            fi
          else
            echo "‚ö†Ô∏è  Invalid JSON response"
            exit 0
          fi

      - name: Report Status
        if: always()
        run: |
          echo "‚úÖ Serial verification worker completed"
          echo "‚ÑπÔ∏è  Next run: +5 minutes (cron schedule)"
